<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="bot-title">Aether AI</title>
    <link rel="icon" type="image/png" href="https://html-generator.com/uploads/images/2025/09/23/36475G8PAZQLZ5Z.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@2.3.8/dist/purify.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>

    <style>
        :root {
            --background-start: #111827;
            --background-end: #1f2937;
            --text-primary: #d1d5db;
            --text-secondary: #9ca3af;
            --user-bubble-start: #14b8a6;
            --user-bubble-end: #06b6d4;
            --bot-bubble: #374151;
            --input-background: #1f2937;
            --accent-glow: rgba(20, 184, 166, 0.4);
            --code-bg: #282c34;
            --bot-message-glow: rgba(5, 150, 105, 0.2);
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background: linear-gradient(180deg, var(--background-start), var(--background-end));
            color: var(--text-primary);
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px;}
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        #chat-input {
            resize: none;
            scrollbar-width: none;
        }
        #chat-input::-webkit-scrollbar {
            display: none;
        }
        
        .message-group {
            display: flex;
            gap: 1rem;
            max-width: 85%;
            align-items: flex-start;
        }
        .message-group.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }
        .message-group.bot {
            align-self: flex-start;
        }
        
        .bot .messages-container {
             box-shadow: 0 0 25px -5px rgba(0,0,0,0.2), 0 0 15px -10px var(--bot-message-glow);
             border-radius: 1.25rem;
             overflow: hidden;
        }

        .messages-container:hover .message-actions {
            opacity: 1;
        }

        .message-actions {
            position: absolute;
            bottom: -5px;
            right: 5px;
            display: flex;
            gap: 0.5rem;
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
            z-index: 10;
        }
        .user .message-actions {
            right: -15px;
        }

        .action-btn {
            background-color: var(--background-end);
            border: 1px solid #4b5563;
            border-radius: 9999px;
            padding: 0.25rem;
            cursor: pointer;
            color: var(--text-secondary);
        }
        .action-btn:hover {
            background-color: #4b5563;
            color: var(--text-primary);
        }

        .message-content {
            padding: 0.75rem 1.25rem;
            word-wrap: break-word;
            line-height: 1.6;
            white-space: pre-wrap;
        }
        .message-content > *:first-child { margin-top: 0; }
        .message-content > *:last-child { margin-bottom: 0; }
        
        .message-content a {
            color: #5eead4;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s;
        }
        .message-content a:hover {
            text-decoration: underline;
            color: #2dd4bf;
        }
        .message-content .contact-link, .message-content .external-link {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            text-decoration: none !important;
        }
        .message-content .contact-link {
            background-color: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
        }
        .message-content .contact-link:hover {
            background-color: rgba(255,255,255,0.1);
            border-color: rgba(255,255,255,0.2);
            color: #99f6e4;
        }

        .message-content ul {
            list-style: none;
            padding: 0;
            margin: 0.75rem 0;
        }
        .message-content li {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 0.25rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        .message-content li:last-child {
            border-bottom: none;
        }
        .message-content li i {
            flex-shrink: 0;
            color: var(--user-bubble-start);
        }
        
        .user .message-content {
            background: linear-gradient(135deg, var(--user-bubble-start), var(--user-bubble-end));
            color: white;
            border-radius: 1.25rem;
            border-bottom-right-radius: 0.5rem;
        }
        .bot .message-content {
            background-color: var(--bot-bubble);
            color: var(--text-primary);
        }

        .bot-avatar {
            flex-shrink: 0;
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--user-bubble-start), var(--user-bubble-end));
            box-shadow: 0 0 15px -3px var(--accent-glow);
        }
        
        .bot .image-container {
            max-width: 320px;
            margin-top: 0.5rem;
        }
         .bot .image-container img {
            display: block;
            width: 100%;
            border-radius: 0.75rem;
        }

        .bot .content-button { 
            display: flex; align-items: center; justify-content: center; gap: 0.5rem; width: 100%; text-align: center;
            background: linear-gradient(135deg, #4b5563, #374151);
            padding: 12px 15px; color: #f9fafb; font-weight: 600;
            transition: all 0.2s ease-in-out;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .bot .content-button:hover { 
            background: linear-gradient(135deg, #374151, #4b5563);
            color: white;
            box-shadow: inset 0 0 15px -5px var(--accent-glow);
        }


        .message-content table { 
            font-size: 0.875rem; 
            width: 100%; 
            border-collapse: separate; 
            border-spacing: 0;
        }
        .bot .message-content table {
            background-color: transparent;
            padding: 0;
        }
        .message-content table td, .message-content table th { 
            padding: 10px 14px; 
            text-align: left; 
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
         .message-content table tr:last-child td {
            border-bottom: none;
        }
        .message-content table th { 
            background-color: rgba(255,255,255,0.05);
            font-weight: 600;
        }
        
        .suggestion-chip {
            transition: all 0.2s;
            background-color: rgba(255, 255, 255, 0.05);
            color: var(--text-secondary);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .suggestion-chip:hover {
            background-color: rgba(255, 255, 255, 0.15);
            color: var(--text-primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .typing-indicator span {
            height: 8px;
            width: 8px;
            background-color: #9ca3af;
            border-radius: 50%;
            display: inline-block;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .typing-indicator span:nth-of-type(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-of-type(2) { animation-delay: -0.16s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }

        #send-btn {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            background: linear-gradient(135deg, var(--user-bubble-start), var(--user-bubble-end));
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        #send-btn:hover:not(:disabled) {
            transform: scale(1.1);
            box-shadow: 0 10px 15px -3px var(--accent-glow), 0 4px 6px -4px var(--accent-glow);
        }
        #send-btn:active:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        
        .message-content pre[class*="language-"] {
            background: var(--code-bg);
            border-radius: 0.75rem;
            padding: 1rem;
            margin: 0.5rem 0;
            overflow: auto;
        }
    </style>
</head>
<body class="flex flex-col h-screen">
    
    <main id="chat-container" class="flex-1 overflow-y-auto p-4 md:p-6">
        <div id="chat-messages" class="max-w-3xl mx-auto flex flex-col space-y-6">
            <div id="welcome-screen" class="text-center py-16">
                <div class="inline-block bg-gray-800 rounded-full mb-6 relative p-2">
                    <div class="absolute inset-0 bg-gradient-to-br from-teal-400 to-cyan-500 rounded-full blur-xl opacity-50"></div>
                    <img id="welcome-logo" src="https://html-generator.com/uploads/images/2025/09/23/36475G8PAZQLZ5Z.png" class="w-16 h-16 relative z-10 rounded-full" alt="Company Logo">
                </div>
                <h1 id="welcome-header" class="text-4xl md:text-5xl font-bold text-white">Welcome to Aether AI</h1>
                <p class="text-gray-400 mt-3 text-lg">Your intelligent assistant for any query.</p>
            </div>
        </div>
    </main>

    <footer class="p-4 bg-transparent">
        <div class="max-w-3xl mx-auto">
            <div id="stop-generating-container" class="flex justify-center mb-2 hidden">
                <button id="stop-generating-btn" class="flex items-center gap-2 px-4 py-2 border border-gray-600 rounded-lg text-gray-300 hover:bg-gray-700">
                    <i data-lucide="square" class="w-4 h-4"></i> Stop generating
                </button>
            </div>
            <div id="suggestion-chips" class="flex flex-wrap gap-2 mb-3 justify-center hidden"></div>
            <div class="relative flex items-end p-2 bg-gray-900/50 rounded-2xl shadow-sm border border-gray-700 backdrop-blur-sm">
                <textarea id="chat-input" placeholder="Ask anything..." class="flex-1 bg-transparent px-4 py-2 border-none focus:outline-none focus:ring-0 text-white placeholder-gray-500" rows="1"></textarea>
                <button id="send-btn" class="text-white rounded-full p-3 flex-shrink-0 disabled:opacity-50 disabled:cursor-not-allowed ml-2">
                    <i data-lucide="send" class="w-5 h-5"></i>
                </button>
            </div>
             <p id="disclaimer-text" class="text-center text-xs text-gray-500 mt-2">Aether AI can make mistakes. Consider checking important information.</p>
        </div>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getDatabase, ref, onValue, push, set } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        const firebaseConfig = {
          apiKey: "AIzaSyCICnKBs4Ko8oiOkoB2Jg_QRP8IqqTzmWo",
          authDomain: "bm-ai-agent.firebaseapp.com",
          databaseURL: "https://bm-ai-agent-default-rtdb.firebaseio.com",
          projectId: "bm-ai-agent",
          storageBucket: "bm-ai-agent.appspot.com",
          messagingSenderId: "177012558344",
          appId: "1:177012558344:web:5a0bed843769b90b1d5fbd",
          measurementId: "G-7S5QDYK17"
        };
        
        const botConfig = {
            name: "Blue Minch AI",
            company: "Blue Minch",
            location: "Siliguri",
            avatarUrl: "https://html-generator.com/uploads/images/2025/09/23/36475G8PAZQLZ5Z.png",
        };
        
        const GEMINI_API_KEY = "AIzaSyCqnzP9H_3c6_V6F1W1UqhMTs7GAZeJETI";
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;
        
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        let allFaqs = {};
        
        let sessionState = {
            isGenerating: false,
            streamInterval: null,
        };
        let initialSuggestionsShown = false;

        const elements = {
            chatContainer: document.getElementById('chat-container'),
            chatMessages: document.getElementById('chat-messages'),
            chatInput: document.getElementById('chat-input'),
            sendBtn: document.getElementById('send-btn'),
            welcomeScreen: document.getElementById('welcome-screen'),
            suggestionChips: document.getElementById('suggestion-chips'),
            stopGeneratingContainer: document.getElementById('stop-generating-container'),
            stopGeneratingBtn: document.getElementById('stop-generating-btn'),
        };
        
        const stopWords = new Set(['a', 'an', 'the', 'is', 'are', 'was', 'were', 'what', 'who', 'when', 'where', 'why', 'how', 'of', 'in', 'on', 'at', 'for', 'to', 'and', 'but', 'or', 'do', 'you', 'me', 'i', 'tell']);
        
        function parseContent(text) {
            const rawHtml = marked.parse(text || '', {
                gfm: true,
                breaks: true,
                highlight: function(code, lang) {
                    const language = Prism.languages[lang] || Prism.languages.markup;
                    return Prism.highlight(code, language, lang);
                }
            });
            return DOMPurify.sanitize(rawHtml);
        }

        function enhanceLinks(container) {
            const links = container.querySelectorAll('a');
            links.forEach(link => {
                if (link.href.startsWith('mailto:')) {
                    link.classList.add('contact-link', 'mail-link');
                    link.innerHTML = `<i data-lucide="mail" class="w-4 h-4"></i><span>${link.innerText}</span>`;
                } else if (link.href.startsWith('tel:')) {
                    link.classList.add('contact-link', 'phone-link');
                    link.innerHTML = `<i data-lucide="phone" class="w-4 h-4"></i><span>${link.innerText}</span>`;
                } else if (link.hostname !== window.location.hostname) {
                     link.classList.add('external-link');
                     link.innerHTML = `<span>${link.innerText}</span><i data-lucide="arrow-up-right" class="w-4 h-4"></i>`;
                     link.target = '_blank';
                     link.rel = 'noopener noreferrer';
                }
            });
            
            const lists = container.querySelectorAll('ul');
            lists.forEach(list => {
                const listItems = list.querySelectorAll('li');
                listItems.forEach(item => {
                    const text = item.innerHTML;
                    if (text.toLowerCase().includes('website')) {
                        item.innerHTML = `<i data-lucide="globe" class="w-5 h-5"></i><div>${text}</div>`;
                    } else if (text.toLowerCase().includes('email')) {
                        item.innerHTML = `<i data-lucide="mail" class="w-5 h-5"></i><div>${text}</div>`;
                    } else if (text.toLowerCase().includes('phone') || text.toLowerCase().includes('call')) {
                        item.innerHTML = `<i data-lucide="phone" class="w-5 h-5"></i><div>${text}</div>`;
                    }
                });
            });

            lucide.createIcons();
        }

        function scrollToBottom() { elements.chatContainer.scrollTop = elements.chatContainer.scrollHeight; }
        
        function setGeneratingState(isGenerating) { 
            sessionState.isGenerating = isGenerating; 
            elements.sendBtn.disabled = isGenerating; 
            elements.chatInput.disabled = isGenerating; 
            elements.stopGeneratingContainer.classList.toggle('hidden', !isGenerating); 
        }

        function streamResponse(messageContainer, fullText) {
            setGeneratingState(true);
            const words = fullText.split(' ');
            let wordIndex = 0;
            messageContainer.textContent = '';

            sessionState.streamInterval = setInterval(() => {
                if (wordIndex < words.length) {
                    messageContainer.textContent += (wordIndex > 0 ? ' ' : '') + words[wordIndex];
                    wordIndex++;
                    scrollToBottom();
                } else {
                    stopStreaming(messageContainer, fullText);
                }
            }, 50);
        }

        function stopStreaming(messageContainer, fullText) {
            if (sessionState.streamInterval) {
                clearInterval(sessionState.streamInterval);
                sessionState.streamInterval = null;
            }
            if (messageContainer && fullText) {
                messageContainer.innerHTML = parseContent(fullText);
                enhanceLinks(messageContainer.parentElement);
                Prism.highlightAll();
            }
            setGeneratingState(false);
        }

        function addThinkingIndicator() { 
            elements.welcomeScreen.classList.add('hidden'); 
            elements.suggestionChips.classList.add('hidden'); 
            const existingIndicator = elements.chatMessages.querySelector('.thinking-indicator-group'); 
            if (existingIndicator) return; 
            const messageGroup = document.createElement('div'); 
            messageGroup.className = 'message-group bot thinking-indicator-group'; 
            const avatar = document.createElement('div'); 
            avatar.className = 'bot-avatar'; 
            if (botConfig.avatarUrl) { 
                avatar.innerHTML = `<img src="${botConfig.avatarUrl}" class="w-full h-full rounded-full" alt="Bot Avatar">`; 
            } else { 
                avatar.innerHTML = `<i data-lucide="bot" class="text-white w-6 h-6"></i>`; 
            } 
            messageGroup.appendChild(avatar); 
            const indicatorBubble = document.createElement('div'); 
            indicatorBubble.className = 'flex items-center gap-2 bg-gray-800 px-4 py-2 rounded-full'; 
            indicatorBubble.innerHTML = ` <div class="typing-indicator"> <span></span> <span></span> <span></span> </div> <span class="text-gray-400 text-sm">Thinking...</span> `; 
            messageGroup.appendChild(indicatorBubble); 
            elements.chatMessages.appendChild(messageGroup); 
            lucide.createIcons(); 
            scrollToBottom(); 
        }
        
        function removeThinkingIndicator() { 
            const indicator = elements.chatMessages.querySelector('.thinking-indicator-group'); 
            if (indicator) { indicator.remove(); } 
        }

        function addMessage(sender, content) {
            elements.welcomeScreen.classList.add('hidden');
            elements.suggestionChips.classList.add('hidden');
            const messageGroup = document.createElement('div');
            messageGroup.className = `message-group ${sender}`;
            
            const contentWrapper = document.createElement('div');
            contentWrapper.className = 'w-full relative';

            if (sender === 'bot') {
                const avatar = document.createElement('div');
                avatar.className = 'bot-avatar';
                if (botConfig.avatarUrl) {
                    avatar.innerHTML = `<img src="${botConfig.avatarUrl}" class="w-full h-full rounded-full" alt="Bot Avatar">`;
                } else {
                    avatar.innerHTML = `<i data-lucide="bot" class="text-white w-6 h-6"></i>`;
                }
                messageGroup.appendChild(avatar);
            }
            
            const messagesContainer = document.createElement('div');
            messagesContainer.className = 'messages-container flex flex-col w-full';
            messagesContainer.innerHTML = content;
            
            contentWrapper.appendChild(messagesContainer)

            if (sender === 'user') {
                 const actionsHTML = `<div class="message-actions"><button class="action-btn copy-message-btn" title="Copy"><i data-lucide="copy" class="w-4 h-4 pointer-events-none"></i></button></div>`;
                 contentWrapper.innerHTML += actionsHTML;
            }

            messageGroup.appendChild(contentWrapper);
            elements.chatMessages.appendChild(messageGroup);
            lucide.createIcons();
            scrollToBottom();
            return messagesContainer;
        }
        
        function createUserMessageHTML(content) {
             const htmlContent = content.replace(/</g, "&lt;").replace(/>/g, "&gt;");
             return `<div class="message-content">${htmlContent}</div>`;
        }
        
        function createBotMessageHTML(content, blocks) {
            let html = `<div class="message-content">${content}</div>`;
            if (blocks) {
                html += blocks;
            }
            return html;
        }

        function createBlockHTML(blockData) {
            switch (blockData.type) {
                case 'image':
                    return `<div class="image-container"><img src="${blockData.url}" alt="Chatbot Image"></div>`;
                case 'button':
                    return `<a href="${blockData.url}" target="_blank" rel="noopener noreferrer" class="content-button"><i data-lucide="link-2" class="w-4 h-4"></i><span>${blockData.text}</span></a>`;
                case 'table':
                    let markdownTable = '';
                    const rows = (blockData.content || '').split('\n').filter(r => r.trim() !== '');
                    if (rows.length > 0) {
                        markdownTable += `| ${rows[0].split(',').map(h => h.trim()).join(' | ')} |\n`;
                        markdownTable += `| ${rows[0].split(',').map(() => '---').join(' | ')} |\n`;
                        rows.slice(1).forEach(rowStr => {
                            markdownTable += `| ${rowStr.split(',').map(c => c.trim()).join(' | ')} |\n`;
                        });
                    }
                    return `<div class="message-content">${parseContent(markdownTable)}</div>`;
                default:
                    return '';
            }
        }

        function isBasicQuery(userText) {
            const normalizedText = userText.toLowerCase().trim();
            const conversationalKeywords = [ 'hello', 'hi', 'hey', 'how are you', 'good morning', 'good afternoon', 'good evening', 'bye', 'goodbye', 'see you', 'thanks', 'thank you' ];
            if (conversationalKeywords.some(keyword => normalizedText.startsWith(keyword))) {
                return true;
            }
            const timeKeywords = ['time', 'date', 'day', 'what is the time', 'what is the date', 'what day is it'];
            if (timeKeywords.some(keyword => normalizedText.includes(keyword))) {
                return true;
            }
            const mathRegex = /^(what is|calculate|compute|solve)?\s*[\d\s\.\+\-\*\/\(\)]+$/i;
            if (mathRegex.test(normalizedText) && normalizedText.match(/[\+\-\*\/]/)) {
                return true;
            }
            return false;
        }
        
        async function callGeminiAPI(userQuery, dbContextArray, retries = 3, delay = 1000) {
            const systemPrompt = `You are ${botConfig.name}, a helpful and friendly AI assistant from ${botConfig.company} located in ${botConfig.location}.
- Your main goal is to answer the user's question accurately and conversationally.
- You are provided with context from a knowledge base. Base your answer primarily on this context.
- If the context is empty or does not contain the answer, use your general knowledge but clearly state that the information is not from the company's knowledge base.
- If you don't know the answer and it's not in the context, say that you are unable to answer and that you will notify your human colleagues.
- Format your responses using markdown. Use bold, italics, lists, tables, and emojis to make the response engaging.
- IMPORTANT: For emails, use the markdown format [email@example.com](mailto:email@example.com). For phone numbers, use [123-456-7890](tel:1234567890). For websites, use [Website Name](https://example.com).
- **When creating lists, be concise. For example, instead of "You can contact us via email at...", just write "* Email: [contact@blueminch.com](mailto:contact@blueminch.com)".**
- Always be polite and helpful. Handle greetings, small talk, and other conversational questions naturally.
- The current date is ${new Date().toDateString()}.`;

            let contextString = "No relevant context found in the knowledge base.";
            if (dbContextArray && dbContextArray.length > 0) {
                contextString = "Here is some relevant context from the knowledge base:\n\n" + 
                    dbContextArray.map(faq => 
                        `Q: ${faq.question}\nA: ${faq.reply.filter(r => r.type === 'text').map(r => r.content).join('\n')}`
                    ).join('\n\n---\n\n');
            }

            const payload = {
                contents: [{
                    parts: [{
                        text: `CONTEXT:\n${contextString}\n\nUSER'S QUESTION:\n"${userQuery}"`
                    }]
                }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            try {
                const response = await fetch(GEMINI_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); }

                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    return candidate.content.parts[0].text;
                } else {
                    throw new Error("Invalid response structure from Gemini API");
                }
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                if (retries > 0) {
                    await new Promise(res => setTimeout(res, delay));
                    return callGeminiAPI(userQuery, dbContextArray, retries - 1, delay * 2);
                }
                return `I'm sorry, I'm having trouble connecting to my advanced reasoning services right now.`;
            }
        }
        
        function findRelevantFaqs(userText, topN = 1) {
            const normalize = (text) => text.toLowerCase().replace(/[^\w\s']/gi, '').trim();
            const normalizedUserText = normalize(userText);
            const userTokens = new Set(normalizedUserText.split(' ').filter(word => !stopWords.has(word)));
            
            if (userTokens.size === 0) return [];

            const matches = [];

            for (const key in allFaqs) {
                const faq = allFaqs[key];
                if (faq.question) {
                    const normalizedQuestion = normalize(faq.question);
                    const questionTokens = new Set(normalizedQuestion.split(' ').filter(word => !stopWords.has(word)));
                    const intersection = new Set([...userTokens].filter(x => questionTokens.has(x)));
                    const score = intersection.size / userTokens.size;

                    if (score > 0.1) {
                        matches.push({ score, faq: {...faq, key} });
                    }
                }
            }

            matches.sort((a, b) => b.score - a.score);
            return matches.slice(0, topN).map(match => match.faq);
        }

        async function findAndDisplayReply(userText) {
            if (userText.toLowerCase() === 'clear chat' || userText.toLowerCase() === 'reset conversation') {
                elements.chatMessages.innerHTML = ''; 
                elements.welcomeScreen.classList.remove('hidden'); 
                elements.suggestionChips.classList.remove('hidden');
                displayRandomSuggestions();
                setGeneratingState(false);
                removeThinkingIndicator();
                return;
            }

            const relevantFaqs = findRelevantFaqs(userText);
            const bestMatch = relevantFaqs.length > 0 ? relevantFaqs[0] : null;
            
            const geminiResponse = await callGeminiAPI(userText, relevantFaqs);

            removeThinkingIndicator();

            let blocksHTML = '';
            if (bestMatch && bestMatch.reply) {
                bestMatch.reply.forEach(block => {
                    if (block.type !== 'text') {
                        blocksHTML += createBlockHTML(block);
                    }
                });
            }

            const finalHTML = createBotMessageHTML('', blocksHTML);
            const messageElContainer = addMessage('bot', finalHTML);
            const streamingTarget = messageElContainer.querySelector('.message-content');
            
            if (streamingTarget) {
                streamResponse(streamingTarget, geminiResponse);
            } else {
                setGeneratingState(false);
            }

            if (!bestMatch && !isBasicQuery(userText)) {
                 const unansweredRef = push(ref(db, 'unansweredQuestions'));
                 set(unansweredRef, { question: userText, timestamp: new Date().toISOString() });
            }
        }
        
        function sendMessage(text) {
            const userText = text || elements.chatInput.value.trim();
            if (userText === '' || sessionState.isGenerating) return;
            addMessage('user', createUserMessageHTML(userText));
            
            setGeneratingState(true);
            addThinkingIndicator();

            if (!text) {
               elements.chatInput.value = '';
               elements.chatInput.style.height = 'auto';
            }
            findAndDisplayReply(userText);
        }
        
        function displayRandomSuggestions() {
            const allDBQuestions = Object.values(allFaqs).map(faq => faq.question).filter(Boolean);
            let suggestionsPool = allDBQuestions;
            if (suggestionsPool.length > 0 && !initialSuggestionsShown) {
                const shuffled = [...new Set(suggestionsPool)].sort(() => 0.5 - Math.random());
                const selected = shuffled.slice(0, 3);
                elements.suggestionChips.innerHTML = '';
                selected.forEach(text => {
                    const button = document.createElement('button');
                    button.className = 'suggestion-chip px-4 py-2 rounded-full text-sm';
                    button.textContent = text;
                    elements.suggestionChips.appendChild(button);
                });
                elements.suggestionChips.classList.remove('hidden');
                initialSuggestionsShown = true;
            } else if (suggestionsPool.length > 0) {
                 elements.suggestionChips.classList.remove('hidden');
            }
            else {
                elements.suggestionChips.classList.add('hidden');
            }
        }
        
        function applyBranding() {
            document.getElementById('bot-title').textContent = botConfig.name;
            document.getElementById('welcome-header').textContent = `Welcome to ${botConfig.name}`;
            document.getElementById('disclaimer-text').textContent = `${botConfig.name} can make mistakes. Consider checking important information.`;
            elements.chatInput.placeholder = `Ask ${botConfig.name} anything...`;
            const welcomeLogo = document.getElementById('welcome-logo');
            if (botConfig.avatarUrl) {
                welcomeLogo.src = botConfig.avatarUrl;
            }
        }

        elements.sendBtn.addEventListener('click', () => sendMessage());
        elements.chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        elements.chatInput.addEventListener('input', () => {
            elements.chatInput.style.height = 'auto';
            elements.chatInput.style.height = `${elements.chatInput.scrollHeight}px`;
        });
        elements.suggestionChips.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') sendMessage(e.target.textContent);
        });
        elements.chatMessages.addEventListener('click', (e) => {
            const copyBtn = e.target.closest('.copy-message-btn');
            if (copyBtn) {
                const messageContainer = copyBtn.closest('.messages-container, .message-content');
                if (messageContainer) {
                    const textToCopy = messageContainer.innerText;
                    const textArea = document.createElement('textarea');
                    textArea.value = textToCopy;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);

                    const iconContainer = copyBtn;
                    iconContainer.innerHTML = `<i data-lucide="check" class="w-4 h-4 text-green-400"></i>`;
                    lucide.createIcons();
                    setTimeout(() => {
                        iconContainer.innerHTML = `<i data-lucide="copy" class="w-4 h-4 pointer-events-none"></i>`;
                        lucide.createIcons();
                    }, 2000);
                }
            }
        });

        elements.stopGeneratingBtn.addEventListener('click', () => stopStreaming(null, null));

        onValue(ref(db, 'faqs'), (snapshot) => {
            allFaqs = snapshot.val() || {};
            console.log("Firebase FAQs loaded.");
            if (elements.chatMessages.children.length <= 1) { 
                 displayRandomSuggestions();
            }
        });
        
        applyBranding();
        lucide.createIcons();
    </script>
</body>
</html>

