<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        @keyframes gradient-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background: linear-gradient(-45deg, #1e3a8a, #4c1d95, #3b0764, #111827);
            background-size: 400% 400%;
            animation: gradient-animation 20s ease infinite;
            color: white;
            overflow: hidden;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 4px;}
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.5); }

        #chat-input {
            resize: none;
            scrollbar-width: none; /* For Firefox */
        }
        #chat-input::-webkit-scrollbar {
            display: none; /* For Chrome, Safari, and Opera */
        }
        #chat-input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translate3d(0, 30px, 0);
            }
            to {
                opacity: 1;
                transform: translate3d(0, 0, 0);
            }
        }

        .message-group {
            display: flex;
            gap: 1rem;
            max-width: 85%;
            align-items: flex-start;
            animation: fadeInUp 0.6s ease-out forwards;
        }

        .message-group.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }
        .message-group.bot {
            align-self: flex-start;
        }
        
        .message-content {
            padding: 0.75rem 1rem;
            border-radius: 1.25rem;
            word-wrap: break-word;
            line-height: 1.6;
        }
        .user .message-content {
            background-color: rgba(79, 70, 229, 0.7);
            color: white;
            border-bottom-right-radius: 0.5rem;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .bot .message-content {
            background-color: rgba(255, 255, 255, 0.15);
            color: #f9fafb;
            border-bottom-left-radius: 0.5rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .bot-avatar {
            flex-shrink: 0;
            width: 2.5rem; /* 40px */
            height: 2.5rem; /* 40px */
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            box-shadow: 0 0 15px rgba(124, 58, 237, 0.5);
        }

        .bot-message-block {
            border-radius: 1.25rem;
            overflow: hidden;
            background-color: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        .bot-message-block.has-content { padding: 0; }
        .bot-message-block .content-block { padding: 10px 15px; }
        .bot-message-block img.content-block { 
            padding: 0; 
            max-width: 100%; 
            height: auto;
            display: block; 
        }
        .bot-message-block .content-button { 
            display: flex; 
            align-items: center;
            gap: 0.5rem;
            width: 100%; 
            text-align: left;
            background-color: rgba(255, 255, 255, 0.1);
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            padding: 12px 15px; 
            color: #ffffff; 
            font-weight: 600;
            transition: all 0.2s;
            text-decoration: none;
        }
        .bot-message-block .content-button:hover { 
            background-color: rgba(255, 255, 255, 0.2); 
            padding-left: 20px;
        }
        .bot-message-block .content-table { font-size: 0.875rem; width: 100%; border-collapse: collapse; }
        .bot-message-block .content-table td, .bot-message-block .content-table th { border: 1px solid rgba(255, 255, 255, 0.2); padding: 6px 10px; }
        .bot-message-block .content-table th { background-color: rgba(255, 255, 255, 0.1); }

        .suggestion-chip {
            transition: all 0.2s;
            background-color: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            backdrop-filter: blur(5px);
        }
        .suggestion-chip:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 6px 10px -1px rgb(0 0 0 / 0.1), 0 4px 6px -2px rgb(0 0 0 / 0.1);
            background-color: rgba(255, 255, 255, 0.25);
        }
        
        .typing-indicator span {
            height: 8px;
            width: 8px;
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 50%;
            display: inline-block;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .typing-indicator span:nth-of-type(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-of-type(2) { animation-delay: -0.16s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }

        .chat-input-container {
            background-color: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .welcome-icon {
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes send-click {
            0% { transform: scale(1.1); }
            50% { transform: scale(0.9); }
            100% { transform: scale(1.1); }
        }
        #send-btn.clicked {
             animation: send-click 0.3s ease-out;
        }

    </style>
</head>
<body class="flex flex-col h-screen">
    
    <!-- Main Chat Area -->
    <main id="chat-container" class="flex-1 overflow-y-auto p-4 md:p-6">
        <div id="chat-messages" class="max-w-3xl mx-auto flex flex-col space-y-6">
            <!-- Welcome Screen -->
            <div id="welcome-screen" class="text-center py-16">
                <div class="welcome-icon inline-block p-4 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full shadow-lg mb-4">
                    <i data-lucide="sparkles" class="text-white w-10 h-10"></i>
                </div>
                <h1 class="text-4xl md:text-5xl font-bold text-white">Greetings!</h1>
                <p class="text-gray-200 mt-2 text-lg">How may I assist you today?</p>
            </div>
            <!-- Messages will be injected here -->
        </div>
    </main>

    <!-- Input Area -->
    <footer class="p-4 bg-transparent">
        <div class="max-w-3xl mx-auto">
            <!-- Suggestion Chips -->
            <div id="suggestion-chips" class="flex flex-wrap gap-2 mb-3 justify-center">
                <!-- Chips will be dynamically inserted here -->
            </div>
            <!-- Input Form -->
            <div class="chat-input-container relative flex items-end p-2 rounded-2xl shadow-sm focus-within:ring-2 focus-within:ring-indigo-400 transition-shadow duration-200">
                <textarea id="chat-input" placeholder="Type your message..." class="flex-1 bg-transparent px-4 py-2 border-none focus:outline-none focus:ring-0 text-white" rows="1"></textarea>
                <button id="send-btn" class="bg-indigo-600 text-white rounded-full p-3 flex-shrink-0 hover:bg-indigo-700 disabled:bg-indigo-300 disabled:cursor-not-allowed ml-2 transition-transform duration-200 hover:scale-110">
                    <i data-lucide="send" class="w-5 h-5"></i>
                </button>
            </div>
             <p class="text-center text-xs text-gray-300 mt-2">Our AI assistant can make mistakes. Consider checking important information.</p>
        </div>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, addDoc, updateDoc, increment, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- SOUND SETUP ---
        let soundsEnabled = false;
        const sendSound = new Tone.Synth({
            oscillator: { type: 'sine' },
            envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 0.1 }
        }).toDestination();

        const receiveSound = new Tone.MembraneSynth({
            pitchDecay: 0.01,
            octaves: 6,
            envelope: { attack: 0.001, decay: 0.2, sustain: 0.01, release: 0.1 }
        }).toDestination();

        // --- FIREBASE SETUP ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : { apiKey: "YOUR_API_KEY", authDomain: "YOUR_AUTH_DOMAIN", projectId: "YOUR_PROJECT_ID" }; // Fallback for local dev
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        setLogLevel('debug');
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-chatbot-app';
        let allFaqs = {};

        // --- AUTHENTICATION ---
        async function authenticateUser() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                console.log("User authenticated:", auth.currentUser.uid);
                loadFaqs();
            } catch (error) {
                console.error("Authentication failed:", error);
            }
        }

        // --- DATA LOADING ---
        function loadFaqs() {
            if (!auth.currentUser) {
                console.log("Waiting for authentication to load FAQs...");
                return;
            }
            const faqsCollection = collection(db, `artifacts/${appId}/public/data/faqs`);
            onSnapshot(faqsCollection, (snapshot) => {
                allFaqs = {};
                snapshot.forEach(doc => {
                    allFaqs[doc.id] = doc.data();
                });
                console.log("FAQs loaded:", allFaqs);
            }, (error) => {
                console.error("Error loading FAQs:", error);
            });
        }

        const elements = {
            chatContainer: document.getElementById('chat-container'),
            chatMessages: document.getElementById('chat-messages'),
            chatInput: document.getElementById('chat-input'),
            sendBtn: document.getElementById('send-btn'),
            welcomeScreen: document.getElementById('welcome-screen'),
            suggestionChips: document.getElementById('suggestion-chips')
        };
        
        // --- KNOWLEDGE BASE ---
        const inbuiltReplies = {
            "General Knowledge": {
                "what is the capital of france": "The capital of France is Paris.",
                "who wrote romeo and juliet": "William Shakespeare wrote 'Romeo and Juliet'.",
                "what are the primary colors": "The primary colors are red, yellow, and blue.",
            },
            "Science & Nature": {
                "why is the sky blue": "The sky appears blue because of a phenomenon called Rayleigh scattering. The Earth's atmosphere scatters shorter-wavelength blue light from the sun more than it scatters red light.",
                "what is photosynthesis": "Photosynthesis is the process used by plants to convert light energy into chemical energy.",
            },
            "Technology": {
                "what is the internet": "The internet is a global network of interconnected computers that allows people to share information and communicate with each other.",
                "what is an ai": "AI, or Artificial Intelligence, is a branch of computer science that deals with creating smart machines.",
            },
            "Jokes & Fun": {
                "tell me a joke": [
                    "Why don't scientists trust atoms? Because they make up everything!",
                    "What do you call a fake noodle? An Impasta!",
                    "I'm reading a book on anti-gravity. It's impossible to put down!"
                ],
            },
            "Common Conversation": {
                "how are you": "As an AI, I don't have feelings, but I'm operating at peak efficiency! How can I help you?",
                "who are you": "I'm an AI assistant designed to provide information and answer your questions.",
                "what can you do": "I can answer questions from my knowledge base, solve basic math problems, and tell you the time. Go ahead and test me!",
                "thank you": "You're welcome! Is there anything else I can help with?",
                "bye": "Goodbye! Have a great day.",
                "hello": "Hello! How can I assist you today?",
            }
        };

        // --- INTELLIGENT PROCESSING FUNCTIONS ---
        const levenshtein = (s1, s2) => {
            if (!s1.length) return s2.length;
            if (!s2.length) return s1.length;
            const arr = [];
            for (let i = 0; i <= s2.length; i++) {
                arr[i] = [i];
                for (let j = 1; j <= s1.length; j++) {
                    arr[i][j] = i === 0 ? j : Math.min(
                        arr[i - 1][j] + 1,
                        arr[i][j - 1] + 1,
                        arr[i - 1][j - 1] + (s1[j - 1] === s2[i - 1] ? 0 : 1)
                    );
                }
            }
            return arr[s2.length][s1.length];
        };

        const normalizeText = (text) => {
            return text.toLowerCase().replace(/[^\w\s]/gi, '').trim();
        };

        // --- DYNAMIC RESPONSE LOGIC ---
        function handleTime(text) {
            const timeKeywords = ['time', 'date', 'day'];
            if (timeKeywords.some(keyword => text.includes(keyword))) {
                 const now = new Date();
                 if (text.includes('time')) {
                     const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                     return `The current time is ${timeString}.`;
                 }
                 if (text.includes('date') || text.includes('day')) {
                     const dateString = now.toLocaleDateString([], { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                     return `Today is ${dateString}.`;
                 }
            }
            return null;
        }

        function handleMath(text) {
            const mathRegex = /^(?:what is|calculate|compute|solve)\s*([ \d\.\+\-\*\/\(\)]+)$/i;
            const simpleMathRegex = /^[ \d\.\+\-\*\/\(\)]+$/;
            
            let expression = null;
            const mathMatch = text.match(mathRegex);
            
            if (mathMatch && mathMatch[1]) {
                expression = mathMatch[1];
            } else if (simpleMathRegex.test(text)) {
                expression = text;
            }

            if (expression) {
                try {
                    const sanitizedExpression = expression.replace(/[^-()\d/*+.\s]/g, '');
                    const result = new Function(`return ${sanitizedExpression}`)();
                    if (isNaN(result) || !isFinite(result)) {
                         return "That looks like a math problem I can't solve. Please check the format.";
                    }
                    return `The answer is ${result}.`;
                } catch (e) {
                    return "I encountered an error trying to solve that. Please try a simpler calculation.";
                }
            }
            return null;
        }

        // --- CORE CHAT FUNCTIONS ---
        function scrollToBottom() {
            elements.chatContainer.scrollTop = elements.chatContainer.scrollHeight;
        }

        function showTypingIndicator() {
            const messageGroup = document.createElement('div');
            messageGroup.className = 'message-group bot';
            messageGroup.id = 'typing-indicator';

            const avatar = document.createElement('div');
            avatar.className = 'bot-avatar';
            avatar.innerHTML = `<i data-lucide="bot" class="text-white w-6 h-6"></i>`;
            messageGroup.appendChild(avatar);

            const indicator = document.createElement('div');
            indicator.className = 'message-content typing-indicator';
            indicator.innerHTML = '<span></span><span></span><span></span>';
            messageGroup.appendChild(indicator);
            
            elements.chatMessages.appendChild(messageGroup);
            lucide.createIcons();
            scrollToBottom();
        }

        function removeTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            if(indicator) indicator.remove();
        }

        function addMessage(sender, contentBlocks) {
            elements.welcomeScreen.classList.add('hidden');
            elements.suggestionChips.classList.add('hidden');

            const messageGroup = document.createElement('div');
            messageGroup.className = `message-group ${sender}`;

            if (sender === 'bot') {
                const avatar = document.createElement('div');
                avatar.className = 'bot-avatar';
                avatar.innerHTML = `<i data-lucide="bot" class="text-white w-6 h-6"></i>`;
                messageGroup.appendChild(avatar);
            }

            const messagesContainer = document.createElement('div');
            messagesContainer.className = 'flex flex-col gap-2 w-full';

            contentBlocks.forEach(block => {
                messagesContainer.appendChild(block);
            });
            
            messageGroup.appendChild(messagesContainer);
            elements.chatMessages.appendChild(messageGroup);
            
            lucide.createIcons();
            setTimeout(scrollToBottom, 10);
        }

        function createBotMessageBlock(blockData) {
            const botMessageBlock = document.createElement('div');
            if (typeof blockData === 'string') {
                botMessageBlock.className = 'message-content';
                botMessageBlock.textContent = blockData;
                return botMessageBlock;
            }

            botMessageBlock.className = 'bot-message-block';
            let contentHTML = '';

            switch (blockData.type) {
                case 'text':
                    botMessageBlock.classList.add('message-content');
                    botMessageBlock.textContent = blockData.content;
                    break;
                case 'image':
                    contentHTML = `<img src="${blockData.url}" class="content-block" alt="Chatbot Image">`;
                    botMessageBlock.classList.add('has-content');
                    botMessageBlock.innerHTML = contentHTML;
                    break;
                case 'button':
                    contentHTML = `<a href="${blockData.url}" target="_blank" rel="noopener noreferrer" class="content-button"><i data-lucide="arrow-right-circle" class="w-5 h-5"></i><span>${blockData.text}</span></a>`;
                    botMessageBlock.classList.add('has-content');
                    botMessageBlock.innerHTML = contentHTML;
                    break;
                case 'table':
                    let tableHTML = '<table class="content-table">';
                    const rows = (blockData.content || '').split('\n');
                    rows.forEach((rowStr, rowIndex) => {
                        tableHTML += '<tr>';
                        rowStr.split(',').forEach(cellStr => {
                            tableHTML += `<${rowIndex === 0 ? 'th' : 'td'}>${cellStr}</${rowIndex === 0 ? 'th' : 'td'}>`;
                        });
                        tableHTML += '</tr>';
                    });
                    tableHTML += '</table>';
                    botMessageBlock.classList.add('has-content');
                    botMessageBlock.innerHTML = tableHTML;
                    break;
            }
            return botMessageBlock;
        }

        async function findAndDisplayReply(userText) {
            const normalizedUserText = normalizeText(userText);
            let response = null;

            response = handleTime(normalizedUserText) || handleMath(normalizedUserText);
            if (response) {
                addMessage('bot', [createBotMessageBlock(response)]);
                return;
            }
            
            let bestMatch = { key: null, score: 0.75 };

            // Priority 2: Firebase FAQs
            for (const key in allFaqs) {
                const faq = allFaqs[key];
                const normalizedQuestion = normalizeText(faq.question);
                const distance = levenshtein(normalizedUserText, normalizedQuestion);
                const score = 1 - distance / Math.max(normalizedUserText.length, normalizedQuestion.length);
                if (score > bestMatch.score) {
                    bestMatch = { key, score, source: 'firebase' };
                }
            }

            // Priority 3: In-built Knowledge Base
            for (const category in inbuiltReplies) {
                for (const question in inbuiltReplies[category]) {
                    const normalizedQuestion = normalizeText(question);
                    const distance = levenshtein(normalizedUserText, normalizedQuestion);
                    const score = 1 - distance / Math.max(normalizedUserText.length, normalizedQuestion.length);
                    if (score > bestMatch.score) {
                        bestMatch = { key: question, score, source: 'inbuilt', category };
                    }
                }
            }

            if (bestMatch.key) {
                if (bestMatch.source === 'firebase') {
                    const matchedFaq = { ...allFaqs[bestMatch.key], key: bestMatch.key };
                    const messageBlocks = matchedFaq.reply.map(createBotMessageBlock);
                    addMessage('bot', messageBlocks);
                    const docRef = doc(db, `artifacts/${appId}/public/data/faqs`, matchedFaq.key);
                    await updateDoc(docRef, { views: increment(1) });
                } else if (bestMatch.source === 'inbuilt') {
                    let answer = inbuiltReplies[bestMatch.category][bestMatch.key];
                    if (Array.isArray(answer)) {
                        answer = answer[Math.floor(Math.random() * answer.length)];
                    }
                    addMessage('bot', [createBotMessageBlock(answer)]);
                }
            } else {
                const messageBlock = createBotMessageBlock("I'm sorry, I don't have an answer for that. My human colleagues will be notified so they can teach me for next time!");
                addMessage('bot', [messageBlock]);
                
                const unansweredCollection = collection(db, `artifacts/${appId}/public/data/unansweredQuestions`);
                await addDoc(unansweredCollection, {
                    question: userText,
                    timestamp: new Date().toISOString()
                });
            }
        }
        
        function sendMessage(text) {
            if (!soundsEnabled) {
                Tone.start();
                soundsEnabled = true;
                console.log('Audio context started');
            }

            const userText = text || elements.chatInput.value.trim();
            if (userText === '') return;
            
            sendSound.triggerAttackRelease("C5", "8n", Tone.now());

            const userMessageBlock = document.createElement('div');
            userMessageBlock.className = 'message-content';
            userMessageBlock.textContent = userText;
            addMessage('user', [userMessageBlock]);
            
            if (!text) {
               elements.chatInput.value = '';
               elements.chatInput.style.height = 'auto';
            }

            showTypingIndicator();

            setTimeout(() => {
                removeTypingIndicator();
                receiveSound.triggerAttackRelease("C4", "8n", Tone.now() + 0.1);
                findAndDisplayReply(userText);
            }, 1000 + Math.random() * 500);
        }
        
        function displayRandomSuggestions() {
            const allSuggestions = [
                "What is the capital of France?", "Tell me a joke", "What is 1024 / 8?",
                "Who wrote Romeo and Juliet?", "Why is the sky blue?", "How are you?",
                "What time is it?", "What is photosynthesis?", "Are you a robot?"
            ];

            const shuffled = allSuggestions.sort(() => 0.5 - Math.random());
            const selected = shuffled.slice(0, 3);

            elements.suggestionChips.innerHTML = '';
            selected.forEach(text => {
                const button = document.createElement('button');
                button.className = 'suggestion-chip text-sm px-4 py-2 rounded-full';
                button.textContent = text;
                elements.suggestionChips.appendChild(button);
            });
        }

        elements.sendBtn.addEventListener('click', () => {
            elements.sendBtn.classList.add('clicked');
            setTimeout(() => elements.sendBtn.classList.remove('clicked'), 300);
            sendMessage();
        });

        elements.chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                elements.sendBtn.click();
            }
        });

        elements.chatInput.addEventListener('input', () => {
            elements.chatInput.style.height = 'auto';
            elements.chatInput.style.height = (elements.chatInput.scrollHeight) + 'px';
        });

        elements.suggestionChips.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                sendMessage(e.target.textContent);
            }
        });

        // --- INITIALIZATION ---
        authenticateUser();
        displayRandomSuggestions();
        lucide.createIcons();

    </script>
</body>
</html>

